## 棋盘控制可视化训练规格（训练路线/题型/实现要点）

### 1. 训练目标与理念
- 通过“控制格”可视化训练，帮助棋手在实战中快速在脑内重建己方/对方的控制图，从而减少 blunder。
- 优先塑造“秒级”风险扫描能力：不把子落进对方控制格、不把子挂起（无防守）、能预判多重攻击、会做静态兑子评估。

### 2. 阶段化训练路径（由浅入深）
- 阶段 1｜单子覆盖（基础感知）
  - 目标：形成对各类棋子控制模式的肌肉记忆（兵/马/象/车/后/王）。
  - 题型：
    - 快闪识别：覆盖层闪现 2 秒后隐藏，要求点出该子能控制/不能控制的格。
    - 对比选择：同一棋子两处摆放，问哪处“控制更多中心/更安全”。
  - 指标：正确率、首击用时；错因（马步/斜线/直线/王）分布。

- 阶段 2｜兵种组合形状（常见图形）
  - 目标：识别并内化典型形状的控制特征与弱点，尤其是兵结构。
  - 覆盖主题示例：
    - 兵结构：兵链、孤兵、双兵、挂兵、通过兵；兵链根的控制与弱点。
    - 轻子配合：马+象对角/据点；双象/双车通路；车第七横。
  - 题型：给出形状→闪现覆盖→遮蔽→标注“强控制格/薄弱格/无防守格”。

- 阶段 3｜威胁与风险识别（对局常见错误的“止损包”）
  - 无防守格（Not Defended）：当前未被己方任何子防守的己方格或己方子所处格。
  - 别走进对方控制格：放置题，给定若干候选落点，选“安全/高性价比”的格；若落入对方控制强的格，扣分并解释。
  - 即将被多重攻击的格（定义与训练）：
    - 定义：某格当前已被对方≥1个子攻击，且在“你走一步、对方走一步”的自然发展内（不牺牲重大子力），对方对该格的攻击数可超过你方的防守数（或提高优势差）。
    - 近似检验（训练用）：以你候选走为前提，评估该格的“攻击者-防守者”差值 ΔA−ΔD；若下一回合对方存在一步可让 A−D ≥ 1，则标记为“即将被多重攻击”。
    - 题型：定位题——闪现覆盖→遮蔽→在全盘中圈出“即将被多重攻击”的前3格；反馈给出对方最自然的一步与差值变化动画。
  - 兑子计算（静态兑子评估 SEE）：
    - 目标：会在单一格上按子力价值与攻守排序估算“兑到最后”的净得失。
    - 题型：给定目标格，显示候选捕吃序列，问“兑子是否划算/应否先手接触”。

- 阶段 4｜开局控制增长与意图理解
  - 目标：用“控制增长曲线”帮助新手理解开局每一步在空间与安全上的意义。
  - 题型：
    - 逐步回放：对比两种开局（如 e4 vs d4），每步展示“控制增量热力图”与中心/翼侧占领度。
    - 预测题：给定 FEN，问“下一步哪一着能让己方控制增长最多/风险最低”。

- 阶段 5（进阶，可选）｜钉住/牵制/发现进攻对控制的影响
  - 概念：钉住会抑制被钉子在特定方向上的“有效控制”。
  - 题型：一键切换“朴素控制 vs 考虑钉住”，要求标注“变化最大”的格并解释原因。

### 3. 核心训练模式（与交互规则）
- 闪现-遮蔽-标注（SPC）
  - 流程：显示覆盖层 2–3 秒 → 局部/全盘遮蔽 → 用户标注指定类型（无防守格/强控制格/即将被多重攻击）。
  - 反馈：即刻显示正确区域与遗漏；给出来源子列表与射线动画；计入用时与错误类型。

- 放置题（避免走进对方控制）
  - 给出若干候选格，要求选择“安全且有效”的落点；
  - 评分：对方控制强度、交换期望（简化 SEE）、中心控制/机动性加权综合分。

- 差分对比题（两步候选）
  - 用户先做“更安全/控制更优”的预测，再展示 Δcontrol/Δeval（eval 可选）。

- 兑子博弈题（SEE）
  - 在目标格上按攻守列表排序模拟捕吃序列，估算净子值；
  - 给出“应否先手接触/是否等对方先接触”的建议与理由。

### 4. 度量与反馈体系
- 技术指标：
  - 正确率、平均反应时、漏判/误判率；
  - 错因分类：马步/象线/车线/兵对角/钉住/多重攻击/兑子计算；
  - Δcontrol（控制增减量）、Δeval（可选接入云评估）。
- 训练管理：
  - 间隔重复（SRS）：错题加权回放；
  - 个性化题单：从个人对局/偏好开局自动抽题；每日 5 题冲刺。

### 5. 面向“新手常见错误”的定制训练
- 不要把子放进对方控制格：放置题/路径规划题，标红“高风险格”，鼓励“先制造/巩固据点”。
- 不要把子挂起（Not Defended）：SPC 模式专项；并提示“一步可自救”走法。
- 即将被多重攻击：定位题 + 动画演示“对手自然一步”如何让 A−D 翻转为不利。
- 兑子误判：在争夺格上做 SEE 训练，并给“反例库”（表面看似可兑，实则亏）。

### 6. 术语与运行定义（训练判分口径）
- 控制格（Control）：某方至少一子能在下一回合抵达或捕吃该格（含兵的对角攻击）。
- 无防守格（Not Defended）：
  - 己方：该格（或己方子所占格）被对方攻击且不被己方任何子防守。
  - 中性：棋盘上未被己方防守的空格（帮助识别“落子即挂”的位置）。
- 多重攻击（Multi-Attacked）：一个格被对方≥2个子攻击。
- 即将被多重攻击：在你走一步后，对方存在“一步自然发展”使目标格的攻击者数量>防守者数量（或优势差扩大到 ≥1）。
- 静态兑子评估（SEE）：在单一格上基于攻守进入顺序、子值（P=1, N/B=3, R=5, Q=9，或细化）估算捕吃到尽头的净子值；不考虑远期战术，仅做战术局部静态估值。

### 7. 技术实现要点（保持 Cloudflare Pages + Functions）
- 前端（现有覆盖层复用，新增）
  - 来源列表与射线动画：悬停某格展示“控制来源子”与射线；
  - 数字叠加（可开关）：每格显示攻守计数；
  - 训练计时/遮蔽器：SPC 的闪现与黑屏定时控件；
  - 简化 SEE：基于攻守列表做本地静态兑子评估，给出净值与建议。
- 后端（Pages Functions）
  - OAuth（PKCE）与会话 Cookie；
  - 题单生成：
    - 从用户近期对局抽取 blunder 前后片段生成“我的易错题单”；
    - 开局控制增长：用开局/棋谱接口拉取常见开局，计算逐步 Δcontrol 曲线；
  - 可选：云评估/表库/开局库作为解释与复盘的辅助数据。
- 重要约束：遵守 Lichess 速率限制，串行请求，遇 429 退避；所有外呼通过 Functions 代理 `lichess.org`。

### 8. 路由与接口草案
- 前端页签：`/train`（训练中心）
  - 模块：基础（阶段1）、形状（阶段2）、风险（阶段3）、开局（阶段4）、进阶（阶段5）。
- Functions：
  - `/api/oauth/start|callback`：OAuth 登录；
  - `/api/me/games`：近期对局摘要（抽题用）；
  - `/api/opening/explore`：给 FEN 返回开局统计与建议；
  - `/api/eval/cloud`（可选）：云评估；
  - `/api/tablebase`（可选）：残局表库；
  - `/api/train/mine`：根据个人错因分布生成个性化题单。

### 9. MVP 与里程碑
- MVP（优先上线）
  - 阶段1 基础覆盖练习（SPC）
  - 阶段3 的两项：Not Defended 与“别走进对方控制格”
  - 指标仪表：正确率、反应时、错因分布
- M1（短期）
  - 兑子 SEE 训练；开局控制增长可视化；个性化错题本
- M2（中期）
  - 即将被多重攻击识别与动画解释；钉住/牵制切换；SRS 题单调度

### 10. 参考
- Lichess API（OAuth、Puzzles、对局/开局/评估/表库等端点）：[https://lichess.org/api](https://lichess.org/api)

### 11. 专注“瞬时势力图”的训练路线（不开局/不战术库）
- 目标：用户“看一眼棋盘（≤2–3 秒）”，能在脑内形成双方控制图，避免把子落进对方强控制区、避免挂子与糟糕兑子。

- A 阶段（微模式识别，单子族群）
  - 练习：马/象/车/后/兵/王分别闪现 2 秒 → 遮蔽 → 标注该子“可控/不可控”格；
  - 变体：随机旋转棋盘、镜像；子型与数量扰动；
  - 通过门槛：正确率 ≥ 90%，平均反应时 ≤ 1.5 s。

- B 阶段（区域块扫描）
  - 练习：仅显示覆盖层热力 2 秒 → 遮蔽 → 标出“中心4格/扩展中心/翼侧”的强控制与薄弱区；
  - 指标：区域误差（IoU）与反应时。

- C 阶段（双侧叠图回忆）
  - 练习：先显示双方覆盖层 2–3 秒 → 遮蔽 → 要求：
    - 标出“我方最脆的3格”（对方控制>我方防守）；
    - 标出“对方最受压的3格”（我方控制>对方防守）。
  - 反馈：来源子列表与射线动画，给出 A−D（攻−守）差值。

- D 阶段（落点安全评估，防止走进对方控制）
  - 练习：给定若干候选格，选“安全且有效”的落点；
  - 评分：风险分（对方控制强度、A−D 差值）+ 有效分（中心/机动性/开发度简单权重）。

- E 阶段（Δcontrol 预判）
  - 练习：给 2 个候选走法，先预测“哪一步更安全/控制更优”，再展示 Δcontrol（增量热力与数值）；
  - 目标：建立“先在脑中改图，再落子”的习惯。

- F 阶段（盲绘全盘）
  - 练习：全盘覆盖层闪现 3 秒 → 遮蔽 → 要求：
    - 方式1：在棋盘上给前 N 个最强控制格着色（双方分开）；
    - 方式2：为每格输入简化强度（0/1/2+）。
  - 通过门槛：前 N 热点命中率 ≥ 80%。

- G 阶段（时间压力与噪声鲁棒）
  - 练习：缩短闪现至 1.5–2 秒；随机旋转/皮肤更换；对子密集局面进行稳健评估；
  - 目标：在对局环境中的“快速稳定读图”。

- 统一训练模板（建议节奏）
  - 5 分钟冲刺：A→C→D（各 90 秒）+ E（60 秒）；
  - 15 分钟标准：A（2）→B（2）→C（4）→D（3）→E（2）→F（2）；
  - 周期评测：每周一次 F 阶段盲绘与 D 阶段安全评估计分，追踪趋势。

- 指标与晋级规则（建议）
  - 单题：正确/错误 + 反应时；组内：平均与 P90；
  - 阶段晋级：连续两次会话达到门槛方可解锁下一阶段；
  - 维护：若 7 天未练，自动回退半阶段进行“复学冲刺”。


