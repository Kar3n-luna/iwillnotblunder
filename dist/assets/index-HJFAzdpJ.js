import{Chessground as Y}from"https://cdn.skypack.dev/@lichess-org/chessground";import{Chess as G}from"https://esm.sh/chess.js@1.4.0";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const q=document.getElementById("board"),l=document.getElementById("overlay"),L=[],$=document.getElementById("fen"),h=new G;$.value=h.fen();let E="w",M="opp",k="opp";const w=Y(q,{orientation:"white",movable:{color:"white",showDests:!0,free:!1,events:{after:Q}},premovable:{enabled:!1},drawable:{enabled:!1,visible:!1}}),T="locale",V={en:{lang:{en:"EN",zh:"中文"},btn:{applyFen:"Apply FEN",reset:"Start position",toggle:"Show/Hide (A)",opp:"Opponent (O)",mine:"Mine (M)",clear:"Hide (H)",switchSide:"Switch side (W/B)"},badge:{shortcuts:"Hotkeys: A show/hide (keep last side) / O opponent / M mine / H hide",drag:"Drag or click to move; overlay updates in real time"},legend:"Red: opponent control; Blue: my control. Opacity scales linearly with count."},zh:{lang:{en:"EN",zh:"中文"},btn:{applyFen:"应用 FEN",reset:"起始局面",toggle:"显示/隐藏 (A)",opp:"只看对方 (O)",mine:"只看己方 (M)",clear:"隐藏 (H)",switchSide:"切换我方(白/黑)"},badge:{shortcuts:"快捷键：A 显示/隐藏（保留最近选择） / O 只对方 / M 只己方 / H 隐藏",drag:"拖拽或点击走子也会实时更新覆盖层"},legend:"红色：对方控制强度；蓝色：己方控制强度。透明度按控制次数线性映射。"}};function J(e,t){const o=t.split(".");let r=e;for(const n of o)if(r&&Object.prototype.hasOwnProperty.call(r,n))r=r[n];else return;return r}let _=localStorage.getItem(T)||"en";function H(e){_=e,localStorage.setItem(T,e);const t=V[e]||V.en;document.querySelectorAll("[data-i18n]").forEach(o=>{const r=o.getAttribute("data-i18n"),n=J(t,r);typeof n=="string"&&(o.textContent=n)}),document.getElementById("lang-en").classList.toggle("active",e==="en"),document.getElementById("lang-zh").classList.toggle("active",e==="zh")}function N(){const e=q.querySelector(".cg-board");if(e&&l.parentElement!==e){e.appendChild(l),l.style.left="0",l.style.top="0",l.style.width="100%",l.style.height="100%";const t=document.createElement("div");t.className="probe-cell",l.appendChild(t),requestAnimationFrame(()=>{const o=t.getBoundingClientRect();l.dataset.cellW=String(Math.floor(o.width)),l.dataset.cellH=String(Math.floor(o.height)),l.removeChild(t),p()})}}function F(){setTimeout(()=>{N(),p()},100)}N();function Q(e,t){if(!h.move({from:e,to:t,promotion:"q"})){w.cancelMove();return}w.set({fen:h.fen(),lastMove:[e,t]}),S(),p()}const U=["a","b","c","d","e","f","g","h"],X=["1","2","3","4","5","6","7","8"],A=(e,t)=>e>=0&&e<8&&t>=0&&t<8,C=(e,t)=>`${String.fromCharCode(97+e)}${t+1}`,Z=e=>({f:e.charCodeAt(0)-97,r:parseInt(e[1],10)-1});function ee(e,t){const{f:o,r}=Z(e),n=[],s=t.color,c=t.type,b=(i,a)=>{if(!A(i,a))return!1;const d=C(i,a);return n.push(d),!h.get(d)};if(c==="p"){const i=s==="w"?1:-1,a=[[o-1,r+i],[o+1,r+i]];for(const[d,f]of a)A(d,f)&&n.push(C(d,f));return n}if(c==="n"){const i=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];for(const[a,d]of i){const f=o+a,m=r+d;A(f,m)&&n.push(C(f,m))}return n}if(c==="k"){const i=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[a,d]of i){const f=o+a,m=r+d;A(f,m)&&n.push(C(f,m))}return n}const g=[];(c==="b"||c==="q")&&g.push([-1,-1],[-1,1],[1,-1],[1,1]),(c==="r"||c==="q")&&g.push([-1,0],[1,0],[0,-1],[0,1]);for(const[i,a]of g){let d=o+i,f=r+a;for(;A(d,f);){b(d,f);const m=C(d,f);if(h.get(m))break;d+=i,f+=a}}return n}function te(){const t=Array.from({length:8},()=>Array(8).fill(0)),o=Array.from({length:8},()=>Array(8).fill(0));for(const r of U)for(const n of X){const s=`${r}${n}`,c=h.get(s);if(!c)continue;const b=ee(s,c);for(const g of b){const i=g.charCodeAt(0)-97,a=parseInt(g[1],10)-1;c.color==="w"?t[a][i]+=1:o[a][i]+=1}}return{white:t,black:o}}function ne(){if(!(l.childElementCount===64&&L.length===64)){l.innerHTML="",L.length=0;for(let e=0;e<64;e++){const t=document.createElement("div");t.className="overlay-cell",t.style.pointerEvents="none",l.appendChild(t),L.push(t)}}}function p(e=M){if(M=e,N(),ne(),e==="none"){for(let u=0;u<64;u++)L[u].style.display="none";return}const{white:t,black:o}=te(),r=E,n=r==="w"?"b":"w",s=6,c=E==="w",b=q.querySelector(".cg-board"),g=b?b.getBoundingClientRect():l.getBoundingClientRect(),i=g.width,a=g.height,d=i/8,f=a/8,m=Array.from({length:9},(u,y)=>y*d),x=Array.from({length:9},(u,y)=>y*f);l.style.left="0px",l.style.top="0px",l.style.width="100%",l.style.height="100%";const K=e==="mine",j=e==="opp";for(let u=0;u<8;u++)for(let y=0;y<8;y++){const P=t[u][y],R=o[u][y],W=r==="w"?P:R,D=n==="w"?P:R,O=c?y:7-y,B=c?7-u:u;let I=0,z="";K&&W>0?(I=Math.min(.7,W/s),z="heat-blue"):j&&D>0&&(I=Math.min(.7,D/s),z="heat");const v=L[B*8+O];v.style.left=m[O]+"px",v.style.top=x[B]+"px",v.style.width=(m[O+1]-m[O]).toFixed(2)+"px",v.style.height=(x[B+1]-x[B]).toFixed(2)+"px",I>0?(v.className="overlay-cell "+z,v.style.setProperty("--alpha",I.toString()),v.style.display="block"):v.style.display="none"}}document.getElementById("btn-apply-fen").addEventListener("click",()=>{const e=$.value.trim();try{h.load(e),w.set({fen:h.fen()}),S(),p()}catch{alert("FEN 无效")}});document.getElementById("btn-reset").addEventListener("click",()=>{h.reset(),w.set({fen:h.fen(),lastMove:void 0}),S(),p()});document.getElementById("btn-toggle").addEventListener("click",()=>{p(M==="none"?k:"none")});document.getElementById("btn-opponent").addEventListener("click",()=>{k="opp",p("opp")});document.getElementById("btn-mine").addEventListener("click",()=>{k="mine",p("mine")});document.getElementById("btn-clear").addEventListener("click",()=>p("none"));window.addEventListener("keydown",e=>{e.key==="a"||e.key==="A"?p(M==="none"?k:"none"):e.key==="o"||e.key==="O"?(k="opp",p("opp")):e.key==="m"||e.key==="M"?(k="mine",p("mine")):(e.key==="h"||e.key==="H")&&p("none")});document.getElementById("btn-switch-side").addEventListener("click",()=>{E=E==="w"?"b":"w",w.set({orientation:E==="w"?"white":"black"}),p()});document.getElementById("lang-en").addEventListener("click",()=>H("en"));document.getElementById("lang-zh").addEventListener("click",()=>H("zh"));const oe=new ResizeObserver(()=>F());oe.observe(document.querySelector(".board-wrap"));window.addEventListener("resize",()=>F());window.addEventListener("orientationchange",()=>setTimeout(()=>F(),500));function S(){const e=h.moves({verbose:!0}),t=new Map;for(const o of e)t.has(o.from)||t.set(o.from,[]),t.get(o.from).push(o.to);w.set({movable:{color:"both",dests:t,showDests:!0,free:!1}})}w.set({orientation:E==="w"?"white":"black"});S();H(_);p();
